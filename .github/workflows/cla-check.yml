# SPDX-FileCopyrightText: 2025 Knitli Inc. <knitli@knit.li>
# SPDX-FileContributor: Adam Poulemanos <adam@knit.li>
#
# SPDX-License-Identifier: MIT OR Apache-2.0
#
# Reusable CLA check workflow for all Knitli repositories
#
# This workflow checks if PR contributors have signed the CLA and stores
# signatures centrally in knitli/.github/cla-signatures/
#
# Usage in your repository:
#   uses: knitli/.github/.github/workflows/cla-check.yml@main
#   with:
#     repo_name: "codeweaver"  # or "thread", etc.
#     cla_document_url: "https://github.com/knitli/codeweaver/blob/main/CLA.md"  # optional
#   secrets: inherit

name: CLA Check

on:
  workflow_call:
    inputs:
      repo_name:
        description: 'Repository name for signature file (e.g., "codeweaver")'
        required: true
        type: string
      cla_document_url:
        description: 'URL to the CLA document'
        required: false
        type: string
        default: ''
      branch:
        description: 'Branch for storing signatures in .github repo'
        required: false
        type: string
        default: 'main'
    secrets:
      CLA_ACCESS_TOKEN:
        description: 'Personal access token with write access to knitli/.github repo'
        required: true

permissions:
  actions: write
  contents: read
  pull-requests: write
  statuses: write

jobs:
  check-cla:
    runs-on: ubuntu-latest
    outputs:
      is_member: ${{ steps.check-membership.outputs.is_member }}
      should_run_cla: ${{ steps.check-membership.outputs.should_run_cla }}
    steps:
      - name: Check Repository
        id: check-repo
        run: |
          repo="${{ github.repository }}"
          if [[ ! $repo =~ ^knitli/ ]]; then
            echo "This action is only for Knitli repositories (found: $repo)"
            echo "is_knitli_repo=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "is_knitli_repo=true" >> "$GITHUB_OUTPUT"

      - name: Check Membership (check all PR committers)
        id: check-membership
        if: steps.check-repo.outputs.is_knitli_repo == 'true'
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          OWNER="$(echo "$REPO" | cut -d/ -f1)"
          REPO_NAME="$(echo "$REPO" | cut -d/ -f2)"

          # Determine PR number or fallback to actor
          PR_NUMBER=""
          if [ -n "${GITHUB_EVENT_PATH:-}" ] && [ -f "$GITHUB_EVENT_PATH" ]; then
            PR_NUMBER="$(jq -r '.pull_request.number // .issue.number // empty' "$GITHUB_EVENT_PATH")" || true
          fi

          # Fallback to actor if we can't find PR number
          if [[ -z "$PR_NUMBER" ]]; then
            echo "No PR number found in event; falling back to single author check"
            if [[ "${{ github.event_name }}" == "pull_request_target" ]]; then
              AUTHOR="${{ github.event.pull_request.user.login }}"
            else
              AUTHOR="${{ github.event.issue.user.login }}"
            fi
            if [[ -z "$AUTHOR" ]]; then
              AUTHOR="${{ github.actor }}"
            fi
            USERS="$AUTHOR"
          else
            echo "PR number detected: $PR_NUMBER"
            # Fetch commits for PR and collect commit authors/committers
            COMMITS_JSON=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/commits")
            # Extract possible GitHub logins (author.login or committer.login) and unique them
            USERS=$(echo "$COMMITS_JSON" | jq -r '.[] | .author.login // .committer.login // empty' | sed '/^$/d' | sort -u || true)
            # If no login found (e.g., imported email-only commits), fall back to PR author/actor
            if [[ -z "$USERS" ]]; then
              echo "No commit-linked GitHub users found; falling back to PR author/actor"
              if [[ -n "${{ github.event.pull_request.user.login || github.event.issue.user.login }}" ]]; then
                USERS="${{ github.event.pull_request.user.login || github.event.issue.user.login }}"
              else
                USERS="${{ github.actor }}"
              fi
            fi
          fi

          echo "Potential committers found: "
          for u in $USERS; do echo " - $u"; done

          # Bot/allowlist detection (case-insensitive)
          is_allowed_bot() {
            local u_lower="$(echo "$1" | tr '[:upper:]' '[:lower:]')"
            # Patterns: endswith [bot], contains bot, or well-known automation accounts
            if [[ "$u_lower" =~ \[bot\]$ ]] || \
               [[ "$u_lower" =~ bot$ ]] || \
               [[ "$u_lower" =~ ^dependabot ]] || \
               [[ "$u_lower" =~ ^github-actions ]] || \
               [[ "$u_lower" =~ ^changeset-bot ]] || \
               [[ "$u_lower" =~ ^claude ]] || \
               [[ "$u_lower" =~ ^copilot ]] || \
               [[ "$u_lower" =~ ^codegen-sh ]] || \
               [[ "$u_lower" =~ ^sourcery ]] || \
               [[ "$u_lower" =~ ^github-code-quality ]]; then
              return 0
            fi
            return 1
          }

          # Check each user for org membership or allowlist
          NEEDS_CLA=()
          for user in $USERS; do
            if [[ -z "$user" ]]; then
              NEEDS_CLA+=("<unknown>")
              continue
            fi

            if is_allowed_bot "$user"; then
              echo "Skipping bot/allowlisted account: $user"
              continue
            fi

            # Query org membership API
            response=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/orgs/knitli/members/$user")

            if [ "$response" == "204" ]; then
              echo "User $user is a Knitli org member"
              continue
            else
              echo "User $user is NOT a Knitli org member and may require CLA"
              NEEDS_CLA+=("$user")
            fi
          done

          if [ ${#NEEDS_CLA[@]} -eq 0 ]; then
            echo "All committers are org members or allowed bots; CLA not required"
            echo "is_member=true" >> "$GITHUB_OUTPUT"
            echo "should_run_cla=false" >> "$GITHUB_OUTPUT"
          else
            echo "The following committers need to sign the CLA: ${NEEDS_CLA[*]}"
            echo "is_member=false" >> "$GITHUB_OUTPUT"
            echo "should_run_cla=true" >> "$GITHUB_OUTPUT"
          fi

  cla-assistant:
    needs: check-cla
    if: needs.check-cla.outputs.should_run_cla == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Determine CLA Document URL
        id: cla-url
        run: |
          # Use provided URL or construct default from repo
          if [[ -n "${{ inputs.cla_document_url }}" ]]; then
            url="${{ inputs.cla_document_url }}"
          else
            url="https://github.com/${{ github.repository }}/blob/main/CONTRIBUTORS_LICENSE_AGREEMENT.md"
          fi
          echo "url=$url" >> "$GITHUB_OUTPUT"
          echo "Using CLA document: $url"

      - name: CLA Assistant
        uses: contributor-assistant/github-action@ca4a40a7d1004f18d9960b404b97e5f30a505a08
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PERSONAL_ACCESS_TOKEN: ${{ secrets.CLA_ACCESS_TOKEN }}
        with:
          # Remote repository configuration
          remote-organization-name: knitli
          remote-repository-name: .github
          path-to-signatures: cla-signatures/${{ inputs.repo_name }}.json

          # CLA document location
          path-to-document: ${{ steps.cla-url.outputs.url }}

          # Branch for signatures
          branch: ${{ inputs.branch }}

          # Bot allowlist (users who don't need to sign)
          allowlist: |
            Claude,Copilot,Codegen-sh,Dependabot,Github-Actions,codegen-sh[bot],dependabot[bot],github-actions[bot],actions-user,changeset-bot,claude[bot],copilot

          # Commit messages
          create-file-commit-message: 'chore: initialize CLA signatures for ${{ inputs.repo_name }}'
          signed-commit-message: '${{ github.event.pull_request.user.login || github.event.issue.user.login }} signed the CLA for ${{ inputs.repo_name }} PR #${{ github.event.pull_request.number || github.event.issue.number }}'

          # Custom PR comments
          custom-notsigned-prcomment: |
            üëã Hey @${{ github.event.pull_request.user.login || github.event.issue.user.login }},

            ## Thanks for your contribution to ${{ inputs.repo_name }}! üßµ

            ### You need to agree to the CLA first... üñäÔ∏è

            Before we can accept your contribution, **you need to agree to our Contributor License Agreement (CLA)**.

            ### To agree to the CLA, please comment:

            > I read the contributors license agreement and I agree to it.

            Those exact words are important[^1], so please don't change them. üòâ

            You can read the full CLA here: [Contributor License Agreement](${{ steps.cla-url.outputs.url }})

            [^1]: Our bot needs those *exact* words to recognize that you agree to the CLA.

          custom-pr-sign-comment: |
            ‚úÖ @${{ github.event.pull_request.user.login || github.event.issue.user.login }} has signed the CLA.

          custom-allsigned-prcomment: |
            ## üöÄ All contributors have signed the CLA! üëç

            ### Thanks for your contribution to ${{ inputs.repo_name }}! üßµ

            Your contribution is ready to be reviewed and merged[^1]. üéâ

            [^1]: Pending other CI checks, of course. üòâ
